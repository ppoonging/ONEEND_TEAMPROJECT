<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì±„íŒ…ë°©</title>
    <meta charset="UTF-8">

    <!-- SockJS / Stomp -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #F5E1C8; /* ë² ì´ì§€ ë°°ê²½ */
            font-family: 'Arial', sans-serif;
        }

        .chat-container {
            max-width: 400px;
            margin: 20px auto;
            background-color: #FAF3E0; /* ë² ì´ì§€ ê³„ì—´ */
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background-color: #D2B48C; /* ë² ì´ì§€ */
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-count {
            font-size: 14px;
            color: white;
            text-align: center;
            margin-top: 5px;
        }

        .chat-box {
            height: 500px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #F4EDE4; /* ì—°í•œ ë² ì´ì§€ */
        }

        .message {
            max-width: 75%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .my-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .other-message {
            align-self: flex-start;
        }

        .message-box {
            padding: 10px;
            border-radius: 12px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .my-message .message-box {
            background-color: #D2B48C; /* ë² ì´ì§€ */
            color: black;
            border-radius: 12px 12px 0px 12px;
        }

        .other-message .message-box {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px 12px 12px 0px;
        }

        .system-message {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            margin: 5px 0;
        }

        .input-group {
            padding: 10px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-group input {
            border-radius: 20px;
            border: 1px solid #e0e0e0;
            padding: 10px;
            font-size: 14px;
        }

        .send-btn {
            background-color: #D2B48C; /* ë² ì´ì§€ */
            border-radius: 20px;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            margin-left: 5px;
        }

        .exit-btn {
            background-color: #8B4513; /* ì–´ë‘ìš´ ë¸Œë¼ìš´ */
            color: white;
            border-radius: 20px;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            margin-top: 5px;
            display: block;
            width: 100%;
            text-align: center;
        }
    </style>
</head>

<body>
<div class="chat-container">
    <div class="chat-header">
        <span th:text="${room.name}">ì±„íŒ…ë°© ì´ë¦„</span>
        <div class="user-count" id="userCount">ì ‘ì†ì: 0ëª…</div>
    </div>

    <!-- ì±„íŒ… ë°•ìŠ¤ -->
    <div id="chat" class="chat-box"></div>

    <!-- ë©”ì‹œì§€ ì…ë ¥ì°½ -->
    <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button id="sendButton" class="send-btn">ë³´ë‚´ê¸°</button>
    </div>

    <!-- ë‚˜ê°€ê¸° ë²„íŠ¼ -->
    <button id="exitButton" class="exit-btn">ë‚˜ê°€ê¸°</button>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        let roomId = [[${room.roomId}]];
        let user = [[${user.nickname}]];
        let socket = new SockJS('/ws-chat');
        let stompClient = Stomp.over(socket);

        // ì›¹ì†Œì¼“ ì—°ê²° ë° êµ¬ë…
        stompClient.connect({}, function () {
            console.log('âœ… ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');

            // ì±„íŒ…ë°© ë©”ì‹œì§€ ìˆ˜ì‹ 
            stompClient.subscribe('/topic/chat/room/' + roomId, function (message) {
                let msgData = JSON.parse(message.body);
                let chatBox = document.getElementById('chat');
                let msgElement = document.createElement('div');

                console.log("ğŸ’¬ ë°›ì€ ë©”ì‹œì§€: ", msgData);

                if (msgData.type === 'CHAT') {
                    msgElement.className = msgData.sender === user ? 'my-message' : 'other-message';
                    msgElement.innerHTML = `<div class="message-box"><b>${msgData.sender}</b><br>${msgData.message}</div>`;
                } else if (msgData.type === 'ENTER') {  // JOIN â†’ ENTER ë³€ê²½
                    msgElement.className = "system-message";
                    msgElement.innerHTML = `ğŸš€ ${msgData.sender}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`;
                } else if (msgData.type === 'LEAVE') {
                    msgElement.className = "system-message";
                    msgElement.innerHTML = `ğŸ‘‹ ${msgData.sender}ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`;
                } else if (msgData.type === 'USER_COUNT') {
                    document.getElementById('userCount').innerText = `ì ‘ì†ì: ${msgData.count}ëª…`;
                    return;
                }
                chatBox.appendChild(msgElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // ì„œë²„ì— ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            stompClient.send("/app/chat/enter", {}, JSON.stringify({
                roomId: roomId,
                sender: user
            }));
        });

        // ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥
        document.getElementById('sendButton').addEventListener('click', function () {
            let msg = document.getElementById('messageInput').value.trim();
            if (msg !== '') {
                stompClient.send("/app/chat/message/" + roomId, {}, JSON.stringify({
                    roomId: roomId,
                    sender: user,
                    message: msg,
                    type: 'CHAT'
                }));
                document.getElementById('messageInput').value = '';
            }
        });

        // ë‚˜ê°€ê¸° ë²„íŠ¼
        document.getElementById('exitButton').addEventListener('click', function () {
            stompClient.send("/app/chat/message/" + roomId, {}, JSON.stringify({
                roomId: roomId,
                sender: user,
                type: 'LEAVE'
            }));
            stompClient.disconnect();
            window.location.href = "/chat/rooms";  // ì˜¬ë°”ë¥¸ URLë¡œ ì´ë™
        });
    });
</script>

</body>
</html>
