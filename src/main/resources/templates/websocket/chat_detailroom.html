<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì±„íŒ…ë°©</title>
    <meta charset="UTF-8">

    <!-- SockJS / Stomp -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        .chat-box {
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .my-message {
            text-align: right;
        }

        .other-message {
            text-align: left;
        }

        .message-box {
            display: inline-block;
            padding: 10px;
            border-radius: 10px;
            margin: 5px 0;
            max-width: 70%;
            word-wrap: break-word;
        }

        .my-message .message-box {
            background-color: #d1e7dd;
        }

        .other-message .message-box {
            background-color: #fff;
            border: 1px solid #dee2e6;
        }

        .system-message {
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
            margin: 10px 0;
        }

        .time {
            display: block;
            font-size: 0.75rem;
            color: gray;
            margin-top: 5px;
        }

        .image-message {
            max-width: 100%;
            height: auto;
            margin-bottom: 5px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 th:text="${room.name}">ì±„íŒ…ë°© ì´ë¦„</h3>
        <div>
            <span id="userCount" class="badge bg-secondary me-2">ì ‘ì†ì: 1ëª…</span>
            <button id="leaveButton" class="btn btn-outline-danger btn-sm">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <!-- ì±„íŒ… ë°•ìŠ¤ -->
    <div id="chat" class="chat-box mb-3"></div>

    <!-- ë©”ì‹œì§€ ì…ë ¥ì°½ -->
    <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <input type="file" id="imageInput" accept="image/*" class="form-control" style="max-width: 200px;">
        <button id="sendButton" class="btn btn-primary">ë³´ë‚´ê¸°</button>
    </div>
</div>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
    let roomId = [[${room.roomId}]];
    let user = [[${user.nickname}]];
    let socket = new SockJS('/ws-chat');
    let stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        console.log('âœ… ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');

        //êµ¬ë…
        stompClient.subscribe('/topic/chat/room/' + roomId, function (message) {
            let msgData = JSON.parse(message.body);
            console.log("ğŸ’¬ ë°›ì€ ë©”ì‹œì§€: ", msgData);

            let chatBox = document.getElementById('chat');
            if (!chatBox) {
                console.error("âŒ chatBox ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
                return;
            }

            let msgElement = document.createElement('div');

            if (msgData.type === 'USER_COUNT') {
                document.getElementById('userCount').innerText = 'ì ‘ì†ì: ' + msgData.count + 'ëª…';
                return;
            }

            if (msgData.type === 'ENTER' || msgData.type === 'LEAVE') {
                msgElement.innerHTML = `<div class="system-message">${msgData.sender}ë‹˜ì´ ${msgData.type === 'ENTER' ? 'ì…ì¥' : 'í‡´ì¥'}í•˜ì˜€ìŠµë‹ˆë‹¤.</div>`;
            } else if (msgData.type === 'CHAT') {
                let isMine = msgData.sender === user;
                msgElement.className = isMine ? 'my-message' : 'other-message';

                let messageContent = msgData.image ? `<img src="${msgData.image}" class="image-message"><br>` : '';
                messageContent += msgData.message;

                msgElement.innerHTML = `
                <div class="message-box">
                    <b>${msgData.sender}</b><br>
                    ${messageContent}
                    <span class="time">${new Date(msgData.sendDate).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                </div>`;
            }

            chatBox.appendChild(msgElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        //ì…ì¥
        stompClient.send("/app/chat/enter", {}, JSON.stringify({
            roomId: roomId,
            type: 'ENTER'
        }));
    });

    //ë‚˜ê°€ê¸°
    document.getElementById('leaveButton').addEventListener('click', function () {
        stompClient.send("/app/chat/leave", {}, JSON.stringify({
            roomId: roomId,
            type: 'LEAVE'
        }));
        window.location.href = '/chatroom/rooms';
    });

    //ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('sendButton').addEventListener('click', function () {
        let msg = document.getElementById('messageInput').value.trim();
        if (msg !== '') {
            stompClient.send("/app/chat/message/" + roomId, {}, JSON.stringify({
                roomId: roomId,
                message: msg,
                type: 'CHAT'
            }));
            document.getElementById('messageInput').value = '';
        }
    });

    // ì—”í„°ë¡œ ì „ì†¡
    document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') document.getElementById('sendButton').click();
    });

</script>


</body>
</html>
