<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <div class="d-flex justify-content-center align-items-center page-total-main-bg mb-5 shadow-sm">
        <h2 class="text-center text-white py-2 font-bold-style">한식루트 인증</h2>
    </div>
    <div class="container py-5">
        <section>

            <!--*** content 넣어야할 부분 (넣고 아래 div height 700px 준거 없애줘야 할거임) ***-->
            <div>
                <div class="d-flex justify-content-between fs-6">
                    <h3 th:text="${root.rootTitle}"></h3>
                    <div class="d-flex align-items-center me-2" style="color: #333;">

                        <i class="bi bi-clock-fill me-2 mt-1" style="font-size: 12px"></i>
                        <span
                                th:text="${#temporals.format(root.rootDate, 'yyyy-MM-dd HH:mm')}"
                                th:attr="data-bs-title='수정: ' + ${#temporals.format(root.rootModifyDate, 'yyyy-MM-dd HH:mm')}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                style="cursor: pointer;">
                        </span>
                    </div>
                </div>
                <!-- **내용** -->

                <div class="card">
                    <div class="card-body">
                        <div id="map" style="width: 100%; min-height: 500px; flex-grow: 1;"></div>
                        <div style="width: 100%;" class="py-2 root-li">
                            <ul class="d-flex mb-0 flex-wrap" id="rootSelectList">
                                <li th:each="rootList : ${rootList}" th:text="${rootList.rootListIndex} + '. '
                                    + ${rootList.rootListTitle} + '&nbsp;&nbsp;' "></li>
                            </ul>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <a th:href="@{|/root/register/form/modify/${root.rootSeq}|}" sec:authorize="hasRole('ADMIN')" type="button"
                               class="btn btn-sm btn-outline-secondary me-2">수정</a>
                            <a href="javascript:void(0);" sec:authorize="hasRole('ADMIN')" class="btn btn-sm btn-outline-secondary"
                               id="delete-btn"
                               th:data-url="@{|/root/register/form/delete/${root.rootSeq}|}">
                                삭제
                            </a>
                        </div>

                    </div>

                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <input type="button" id="map-button" class="btn btn-outline-secondary me-2" value="루트 확인">
                <a sec:authorize="isAuthenticated()" th:href="@{/root/form}"  class="btn btn-outline-secondary root-a-outline-se me-2">인증하기</a>
                <a sec:authorize="hasRole('ADMIN')" th:href="@{/root/register/list}"  class="btn btn-outline-secondary root-a-outline-se">목록</a>
            </div>
        </section>
    </div>

    <script th:inline="javascript" layout:fragment="script">
        // 카카오맵 적용 버전 (글 수정 화면)
        let map;
        let polyline;
        let marker;
        let rootList = /*[[${root.rootList}]]*/ [];

        // 마커 배열
        window.markers = [];

        function setMap(center) {
            map = new kakao.maps.Map(document.getElementById("map"), {
                center: center,
                level: 4
            });

            if (rootList.length > 0) {
                displayMap(rootList);
                centerRootMove(rootList);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const center = rootList.length > 0 ? getCenter(rootList) : new kakao.maps.LatLng(37.5666805, 126.9784147);
            setMap(center);

            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
        });

        function displayMap(rootList) {
            if (!rootList || rootList.length === 0) return;
            drawPolyline(rootList);
        }

        function drawPolyline(line) {
            if (!line || line.length === 0) return;

            const path = line.map(data => new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude));

            if (polyline) polyline.setMap(null);

            polyline = new kakao.maps.Polyline({
                map: map,
                path: path,
                strokeColor: '#FA5858',
                strokeWeight: 3,
                strokeOpacity: 1,
                strokeStyle: 'solid'
            });

            addMarkers(line);
        }

        function addMarkers(line) {
            if (window.markers.length > 0) {
                window.markers.forEach(marker => marker.setMap(null));
                window.markers = [];
            }

            line.forEach(data => {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude),
                    map: map
                });
                window.markers.push(marker);
            });
        }

        function centerRootMove(root) {
            if (!root || root.length === 0) return;

            const bounds = new kakao.maps.LatLngBounds();
            root.forEach(data => bounds.extend(new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude)));
            map.setBounds(bounds);
        }

        document.getElementById("map-button").addEventListener("click", function () {
            centerRootMove(rootList);
        });

        function getCenter(root) {
            if (!root || root.length === 0) return new kakao.maps.LatLng(37.5666805, 126.9784147);

            let latSum = 0;
            let lngSum = 0;
            root.forEach(data => {
                latSum += data.rootListLatitude;
                lngSum += data.rootListLongitude;
            });
            return new kakao.maps.LatLng(latSum / root.length, lngSum / root.length);
        }

        document.getElementById("delete-btn").addEventListener("click", function () {
            if (confirm("삭제하시겠습니까?")) {
                window.location.href = this.dataset.url;
            }
        });
    </script>

</main>

</html>
<link rel="stylesheet" type="text/css" th:href="@{/css/mj-design-css.css}">