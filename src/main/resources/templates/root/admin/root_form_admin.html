<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <div class="d-flex justify-content-center align-items-center page-total-main-bg mb-5 shadow-sm">
        <h2 class="text-center text-white py-2 font-bold-style">루트 만들기</h2>
    </div>
    <div class="container py-5">
        <section>
            <div>
                <div class="d-flex justify-content-end mb-2">
                    <label class="switch">
                        <input type="checkbox" id="rootStateToggle" th:checked="${root.rootState} == true">
                        <span class="slider"></span>
                    </label>
                </div>

                <form th:action="@{/root/register/form/save}" th:object="${rootDTO}" id="register-form" method="post" class="needs-validation" novalidate>
                    <div class="mb-2 row">
                        <label for="title" class="col-sm-1 col-form-label">제목</label>
                        <div class="col-sm-11">
                            <input type="text" id="title" name="title" th:field="*{title}" class="form-control" required>
                            <div class="invalid-feedback">제목을 입력해주세요.</div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="keyword" class="col-sm-1 col-form-label">주소 검색</label>
                        <div class="col-sm-10">
                            <input type="text" id="keyword" name="keyword" th:value="${keyword}" class="form-control">
                        </div>
                        <div class="col-1 d-grid">
                            <button type="button" id="search-submit" class="btn btn-outline-primary">검색</button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <div class="d-flex flex-column justify-content-between" style="width: 60%;">
                            <div id="map" style="width: 100%; min-height: 500px; flex-grow: 1;"></div>
                            <div style="width: 100%;" class="pt-1 root-li">
                                <ul class="d-flex mb-0 flex-wrap px-4 py-1" id="rootSelectList">
                                    <li></li>
                                </ul>
                            </div>
                        </div>

                        <div class="" style="width: 35%;">
                            <h6>검색 리스트</h6>
                            <ul id="placesList" class="list-group overflow-auto" style="max-height: 500px;">
                                <li id="search-data-list"></li>
                            </ul>
                        </div>
                    </div>

                    <input type="hidden" id="form-mod" name="formMod" th:value="${rootSeq != null ? 'modify' : 'save'}">
                    <input type="hidden" id="rootListData" name="rootList">
                    <input type="hidden" id="rootState" name="rootState" th:value="${root.rootState}">
                    <input type="hidden" id="rootSeq" name="rootSeq" th:value="${rootSeq}">

                    <div class="d-flex justify-content-end mt-3">
                        <input type="button" id="map-button" class="btn btn-outline-secondary" value="루트 확인">
                        <a th:href="@{/root/register/list}" class="btn btn-outline-secondary root-a-outline-se mx-2">목록</a>
                        <input type="button" id="form-submit" name="form-submit" value="저장" class="btn btn-outline-secondary root-a-outline-se">
                    </div>
                </form>

                <form id="searchForm" th:action="@{/root/register/form/search}" method="get">
                    <input type="hidden" id="hiddenQuery" name="query">
                </form>
            </div>
        </section>
    </div>

    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c5bec21bb637e02ba8a0f93d1871a06c&autoload=false&libraries=services"></script>

    <script th:inline="javascript" layout:fragment="script">
        kakao.maps.load(() => {
            let map;
            let marker;
            let polyline;
            let rootList = /*[[${rootList}]]*/ [];
            let rootState = /*[[${root.rootState}]]*/ [];
            // let infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
            let markers = [];

            function setMap(center) {
                map = new kakao.maps.Map(document.getElementById("map"), {
                    center: center,
                    level: 3
                });
                if (rootList && rootList.length > 0) {
                    const bounds = new kakao.maps.LatLngBounds();
                    rootList.forEach(data => bounds.extend(new kakao.maps.LatLng(data.latitude, data.longitude)));
                    map.setBounds(bounds);
                }
            }

            function getCenter(value) {
                if (!value || value.length === 0) return new kakao.maps.LatLng(37.5666805, 126.9784147);
                let latSum = 0, lngSum = 0;
                value.forEach(data => {
                    latSum += parseFloat(data.latitude);
                    lngSum += parseFloat(data.longitude);
                });
                return new kakao.maps.LatLng(latSum / value.length, lngSum / value.length);
            }

            // 라인 그리기
            function drawPolyline() {
                const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                const path = sessionChkData.map(data => new kakao.maps.LatLng(data.latitude, data.longitude));
                if (polyline) polyline.setMap(null);
                polyline = new kakao.maps.Polyline({
                    map: map,
                    path: path,
                    strokeColor: '#FA5858',
                    strokeWeight: 3,
                    strokeOpacity: 1,
                    strokeStyle: 'solid'
                });
                // 마커 제거
                if (window.markers) window.markers.forEach(m => m.setMap(null));

                window.markers = sessionChkData.map(data => {
                    const position = new kakao.maps.LatLng(data.latitude, data.longitude);
                    const marker = new kakao.maps.Marker({ position, map });
                    marker.customKey = `${data.latitude}_${data.longitude}`;
                    return marker;
                });
            }

            function searchResult(value) {
                const listContainer = document.getElementById("placesList");
                listContainer.innerHTML = "";

                const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                const polylinePath = [];

                // 마커 초기화
                if (window.markers) window.markers.forEach(m => m.setMap(null));
                window.markers = [];

                if (value.length === 0) {
                    listContainer.innerHTML = "<li>검색 결과가 없습니다.</li>";
                    return;
                }

                value.forEach(data => {
                    const li = document.createElement('li');
                    li.classList.add('d-flex', 'flex-row', 'p-2', 'root-li');

                    const isChecked = sessionChkData.some(item =>
                        item.title === data.place_name &&
                        item.latitude === data.y &&
                        item.longitude === data.x
                    );

                    li.innerHTML = `
            <div class="my-2 p-2" style="width: 90%;">
                <h6 style="font-weight: bold; cursor: pointer;" name="click-address"
                    data-lat="${data.y}" data-lng="${data.x}">${data.place_name}</h6>
                <p class="mb-2" style="font-size: 14px; color: #777">카테고리: ${data.category_name}</p>
                <p class="mb-2" style="font-size: 14px; color: #444">주소: ${data.address_name}</p>
                <p class="mb-0" style="font-size: 14px; color: #444">도로명: ${data.road_address_name || ''}</p>
            </div>
            <div class="d-flex justify-content-center align-items-center" style="width: 10%">
                <div class="checkbox-form">
                    <input type="checkbox" name="checkbox" class="root-checkbox-input"
                        data-title="${data.place_name}"
                        data-address="${data.address_name}"
                        data-roadaddress="${data.road_address_name || ''}"
                        data-latitude="${data.y}"
                        data-longitude="${data.x}"
                        data-link="${data.place_url}"
                        data-category="${data.category_name}"
                        ${isChecked ? 'checked' : ''} />
                </div>
            </div>`;

                    listContainer.appendChild(li);

                    // 체크된 경우 마커 + 경로에 추가
                    if (isChecked) {
                        const position = new kakao.maps.LatLng(parseFloat(data.y), parseFloat(data.x));
                        const checkedMarker = new kakao.maps.Marker({ position, map });
                        checkedMarker.customKey = `${data.y}_${data.x}`; // 고유 식별자 부여
                        window.markers.push(checkedMarker);

                    }
                });

                // 폴리라인 그리기
                if (polyline) polyline.setMap(null);
                if (polylinePath.length > 0) {
                    polyline = new kakao.maps.Polyline({
                        path: polylinePath,
                        strokeColor: '#FA5858',
                        strokeWeight: 3,
                        strokeOpacity: 1,
                        strokeStyle: 'solid',
                        map: map
                    });
                }

                CheckboxEvents();
                clickAddressEvents();
            }

            function CheckboxEvents() {
                document.querySelectorAll('input[name="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener("change", function () {
                        const obj = {
                            title: checkbox.dataset.title,
                            address: checkbox.dataset.address,
                            roadaddress: checkbox.dataset.roadaddress,
                            latitude: checkbox.dataset.latitude,
                            longitude: checkbox.dataset.longitude,
                            link: checkbox.dataset.link,
                            category: checkbox.dataset.category
                        };

                        let sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                        if (this.checked) {
                            if (!sessionChkData.some(item => item.title === obj.title)) sessionChkData.push(obj);

                            const position = new kakao.maps.LatLng(parseFloat(obj.latitude), parseFloat(obj.longitude));
                            map.setCenter(position);
                            map.setLevel(3);

                            const newMarker = new kakao.maps.Marker({ position, map });
                            newMarker.customKey = `${obj.latitude}_${obj.longitude}`;
                            window.markers.push(newMarker);

                        } else {
                            sessionChkData = sessionChkData.filter(item => item.title !== obj.title);
                        }
                        sessionStorage.setItem("checkRoot", JSON.stringify(sessionChkData));
                        updateSelectList();
                        drawPolyline();
                    });
                });
            }

            function clickAddressEvents() {
                document.querySelectorAll('h6[name="click-address"]').forEach(data => {
                    data.addEventListener("click", function () {
                        const lat = parseFloat(data.dataset.lat);
                        const lng = parseFloat(data.dataset.lng);
                        const position = new kakao.maps.LatLng(lat, lng);
                        map.setCenter(position);
                        map.setLevel(3);
                        if (marker) marker.setMap(null);
                        marker = new kakao.maps.Marker({ position: position, map: map });
                    });
                });
            }

            document.getElementById("search-submit").addEventListener("click", function () {
                const query = document.getElementById("keyword").value;
                if (query.trim().length === 0) {
                    alert("검색어를 입력하세요.");
                    return;
                }
                const ps = new kakao.maps.services.Places();
                ps.keywordSearch(query, function (data, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        searchResult(data);
                    } else {
                        alert("검색 결과가 없습니다.");
                    }
                });
            });

            const savedLat = sessionStorage.getItem("mapCenterLat");
            const savedLng = sessionStorage.getItem("mapCenterLng");
            let center = rootList && rootList.length > 0 ? getCenter(rootList) : (savedLat && savedLng ? new kakao.maps.LatLng(parseFloat(savedLat), parseFloat(savedLng)) : new kakao.maps.LatLng(37.5666805, 126.9784147));

            setMap(center);

            if (rootList && rootList.length > 0) {
                const formMode = document.getElementById("form-mod").value;
                sessionStorage.setItem("checkRoot", JSON.stringify(rootList));

                if (formMode === "modify") {
                    updateSelectList();
                    drawPolyline();
                }
            } else if (sessionStorage.getItem("savedCheckRoot")) {
                sessionStorage.setItem("checkRoot", sessionStorage.getItem("savedCheckRoot"));
                sessionStorage.removeItem("savedCheckRoot");
                drawPolyline();
            }

            if (rootList && rootList.length > 0) {
                sessionStorage.setItem("checkRoot", JSON.stringify(rootList));
                updateSelectList();
            } else if (sessionStorage.getItem("savedCheckRoot")) {
                sessionStorage.setItem("checkRoot", sessionStorage.getItem("savedCheckRoot"));
                sessionStorage.removeItem("savedCheckRoot");
                drawPolyline();
            }

            document.getElementById("map-button").addEventListener("click", function () {
                const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                if (sessionChkData.length === 0) {
                    alert("선택된 장소가 없습니다.");
                    return;
                }

                const bounds = new kakao.maps.LatLngBounds();
                sessionChkData.forEach(item => {
                    const latlng = new kakao.maps.LatLng(item.latitude, item.longitude);
                    bounds.extend(latlng);
                });

                map.setBounds(bounds); // ✅ 줌 자동 조절
            });


            // 리스트에 값 넣기
            function updateSelectList() {
                const rootSelectList = document.getElementById("rootSelectList");
                rootSelectList.innerHTML = "";
                const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];

                if (sessionChkData.length === 0) {
                    rootSelectList.innerHTML = "<li> 위치를 추가하세요 </li>";
                    return;
                }

                sessionChkData.forEach((item) => {
                    const li = document.createElement("li");

                    const cleanTitle = item.title;
                    li.textContent = cleanTitle;
                    li.classList.add("root-list-style");

                    // 삭제 버튼 추가
                    const removeBtn = document.createElement("button");

                    const icon = document.createElement("i");
                    icon.classList.add("bi", "bi-x");

                    removeBtn.appendChild(icon);
                    removeBtn.classList.add("root-remove-btn-style");

                    removeBtn.addEventListener("click", (event) => {
                        event.stopPropagation(); // 부모 요소(li)의 클릭 이벤트 방지
                        removeSelectStorage(item);
                    });

                    li.appendChild(removeBtn);

                    li.dataset.title = item.title;
                    li.dataset.address = item.address;
                    li.dataset.roadaddress = item.roadaddress;
                    li.dataset.latitude = item.latitude;
                    li.dataset.longitude = item.longitude;
                    li.dataset.link = item.link;
                    li.dataset.category = item.category;

                    rootSelectList.appendChild(li);
                });
            }


            // 선택된 리스트 클릭 시
            document.getElementById("rootSelectList").addEventListener("click", function (event) {
                if (event.target.classList.contains("root-list-style") || event.target.closest(".root-list-style")) {
                    const ele = event.target.closest(".root-list-style");
                    const lat = parseFloat(ele.dataset.latitude);
                    const lng = parseFloat(ele.dataset.longitude);
                    const position = new kakao.maps.LatLng(lat, lng);

                    map.setCenter(position);
                    map.setLevel(3);

                    if (marker) {
                        marker.setMap(null);
                    }

                    marker = new kakao.maps.Marker({
                        position: position,
                        map: map
                    });
                }
            });

            function removeSelectStorage(value) {
                let sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                sessionChkData = sessionChkData.filter(item => item.title !== value.title);
                sessionStorage.setItem("checkRoot", JSON.stringify(sessionChkData));

                document.querySelectorAll('input[name="checkbox"]').forEach((chk) => {
                    if (chk.dataset.title === value.title) chk.checked = false;
                });

                if (window.markers && window.markers.length > 0) {
                    window.markers = window.markers.filter(marker => {
                        if (marker.customKey === `${value.latitude}_${value.longitude}`) {
                            marker.setMap(null); // 지도에서 제거
                            return false; // markers 배열에서 제거
                        }
                        return true;
                    });
                }

                updateSelectList();
                drawPolyline();
            }

        });


        // 루트 활성화
        document.getElementById("rootStateToggle").addEventListener("change", function () {
            const rootState = this.checked;
            document.getElementById("rootState").value = rootState;
            console.log("rootState: ", rootState);
        });

        document.getElementById("form-submit").addEventListener("click", function (event) {
            console.log("click");

            const saveForm = document.getElementById("register-form");

            let rootList = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
            document.getElementById("rootListData").value = JSON.stringify(rootList);

            const formMode = document.getElementById("form-mod").value;
            const rootSeq = document.getElementById("rootSeq").value;

            if (!saveForm.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                sessionStorage.removeItem("checkRoot");
                sessionStorage.removeItem("mapCenterLat");
                sessionStorage.removeItem("mapCenterLng");

                if (formMode === 'save') {
                    saveForm.action = "/root/register/form/save"; // 저장
                } else if (formMode === 'modify') {
                    alert("수정되었습니다.");
                    saveForm.action = `/root/register/form/modify/${rootSeq}`; // 수정
                }

                saveForm.submit();
            }

            saveForm.classList.add('was-validated');
        });

    </script>
</main>
</html>
<link rel="stylesheet" type="text/css" th:href="@{/css/mj-design-css.css}">
