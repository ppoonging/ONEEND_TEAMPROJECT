<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <div class="d-flex justify-content-center align-items-center page-total-main-bg mb-5 shadow-sm">
        <h2 class="text-center text-white py-2 font-bold-style">한식루트 인증</h2>
    </div>
    <div class="container py-5">
        <!--content-->
        <section>

            <!--*** content 넣어야할 부분 (넣고 아래 div height 700px 준거 없애줘야 할거임) ***-->
            <div th:object="${rootAuthDTO}">
                <!--                <div th:replace="~{form_errors :: formErrorsFragment}"></div>-->
                <form id="select-form" th:action="@{/root/form}" method="get" class="row mb-3 needs-validation"
                      novalidate>
                    <span class="blockquote-footer mb-1">루트 선택을 먼저해주세요, 루트 선택 시 입력한 내용이 초기화됩니다.</span>
                    <label for="select-root" class="col-sm-1 col-form-label">루트 선택</label>
                    <div class="col-sm-11">
                        <select id="select-root" th:field="*{rootSeq}" class="form-select" required>
                            <option value="">선택</option>
                            <option th:each="root : ${root}" th:if="${root.rootState}"
                                    th:value="${root.rootSeq}"
                                    th:text="${root.rootTitle}"
                            >
                            </option>
                        </select>
                        <div class="invalid-feedback">
                            루트를 선택해주세요.
                        </div>
                    </div>

                </form>

                <form th:action="@{/root/form/save}" id="register-form" enctype="multipart/form-data" method="post"
                      class="needs-validation" novalidate>
                    <div class="mb-2 row">
                        <label for="title" class="col-sm-1 col-form-label">제목</label>
                        <div class="col-sm-11">
                            <input type="text" id="title" name="title" th:field="*{title}" class="form-control"
                                   required>
                            <div class="invalid-feedback">
                                제목을 입력해주세요.
                            </div>
                        </div>

                    </div>
                    <div class="d-flex justify-content-between" style=" height: 580px;">

                        <!--left-->
                        <div class="d-flex flex-column justify-content-between" style="width: 60%;">
                            <!--top-->
                            <div id="map" style="width: 100%; flex-grow: 1;"></div>

                            <div style="width: 100%;" class="py-1 root-li">
                                <ul class="d-flex mb-0 flex-wrap px-4 py-1" id="rootSelectList">
                                    <li></li>
                                </ul>
                            </div>
                        </div>

                        <!--right-->
                        <div class="h-100 overflow-y-auto" style="width: 35%;">
                            <ul th:if="${selRootList}" class="p-3 mb-0">
                                <li id="search-data-list" th:each="selRootList : ${selRootList}" class="root-li">
                                    <div class="d-flex flex-row p-2 ">
                                        <div class="my-2" style="width: 90%;">
                                            <h6 th:utext="${selRootList.rootListIndex} + '. ' + ${selRootList.rootListTitle}"
                                                style="font-weight: bold; cursor: pointer;" name="click-address"
                                                th:data-lat="${selRootList.rootListLatitude}"
                                                th:data-lng="${selRootList.rootListLongitude}"></h6>
                                            <p th:text="'카테고리: ' + ${selRootList.rootListCategory}" class="mb-2"
                                               style="font-size: 14px; color: #777"></p>
                                            <p th:text="'지번: ' + ${selRootList.rootListAddress}" class="mb-2"
                                               style="font-size: 14px; color: #444"></p>
                                            <p th:text="'도로명: ' + ${selRootList.rootListRodeAddress}" class="mb-0"
                                               style="font-size: 14px; color: #444"></p>
                                            <input type="hidden" id="latitude"
                                                   th:value="${selRootList.rootListLatitude}"/>
                                            <input type="hidden" id="longitude"
                                                   th:value="${selRootList.rootListLongitude}"/>
                                        </div>
                                        <div class="d-flex justify-content-center align-items-center"
                                             style="width: 10%">
                                            <div class="checkbox-form">
                                                <input type="checkbox" id="checkbox" name="checkbox"
                                                       class="root-checkbox-input"
                                                       th:data-title="${selRootList.rootListTitle}"
                                                       th:data-address="${selRootList.rootListAddress}"
                                                       th:data-roadaddress="${selRootList.rootListRodeAddress}"
                                                       th:data-latitude="${selRootList.rootListLatitude}"
                                                       th:data-longitude="${selRootList.rootListLongitude}"
                                                       th:data-link="${selRootList.rootListLink}"
                                                       th:data-category="${selRootList.rootListCategory}"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3 p-2 file-container" style="display:none;">
                                        <input class="form-control form-control-sm file-input" type="file" name="files">
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <p id="checkVaild" class="text-danger mb-1"
                           style="font-size: .875em; margin-top: .25rem; display: none;">리스트를 하나 이상 선택해주세요.</p>
                    </div>
                    <div class="mt-3">
                        <input type="button" id="map-button" class="btn btn-sm btn-outline-secondary" value="루트 확인">
                        <input type="button" id="map-root-remove-button" class="btn btn-sm btn-outline-secondary"
                               value="루트 지우기">
                        <input type="button" id="map-marker-remove-button" class="btn btn-sm btn-outline-secondary"
                               value="마커 지우기">
                    </div>
                    <div class="mt-3">
                        <div>
                            <label for="content" class="form-label">후기</label>
                            <textarea class="form-control" id="content" name="content" th:field="*{content}" required
                                      rows="5"></textarea>
                            <div class="invalid-feedback">
                                내용을 입력해주세요.
                            </div>
                        </div>
                        <input type="hidden" id="rootListData" name="rootList" th:field="*{rootAuthList}">
                        <input type="hidden" id="rootSeq" name="rootSeq">
                        <input type="hidden" id="form-mod" name="formMod"
                               th:value="${rootAuthSeq != null ? 'modify' : 'save'}">
                        <input type="hidden" id="rootAuthSeq" name="rootAuthSeq" th:value="${rootAuthSeq}">
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <a th:href="@{/root/list}" class="btn btn-outline-secondary root-a-outline-se me-2 root-cursor">목록으로</a>
                        <button type="button" id="form-submit" name="form-submit" class="btn btn-outline-secondary root-a-outline-se">저장</button>
                    </div>

                </form>
            </div>

        </section>
    </div>
    <script th:inline="javascript" layout:fragment="script">
        let map;
        let marker;
        let polyline;
        let selPolyline;
        let rootList = /*[[${selRootList}]]*/ [];
        let rootAuthList = /*[[${rootAuthList}]]*/ [];
        let initMaker = [];
        let selMaker = [];

        document.addEventListener("DOMContentLoaded", () => {
            initMap();
            drawPolyline(rootList);
            updateSelectList();

            const isModify = rootAuthList?.length > 0;

            if (isModify) {
                drawAuthPolyline(rootAuthList);
                sessionStorage.setItem("checkRootUser", JSON.stringify(rootAuthList));
                modifySaveCheckList();
            } else {
                document.querySelectorAll('.mb-3 .form-control').forEach(div => {
                    div.parentElement.style.display = 'none';
                });
            }

        });

        function initMap() {
            const center = (rootAuthList?.length > 0)
                ? getCenter(rootAuthList)
                : new kakao.maps.LatLng(37.5666805, 126.9784147);

            map = new kakao.maps.Map(document.getElementById('map'), {
                center,
                level: 4, // zoom
            });

            if (rootList.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                rootList.forEach(d => bounds.extend(new kakao.maps.LatLng(d.rootListLatitude, d.rootListLongitude)));
                map.setBounds(bounds);
            }
        }

        function drawPolyline(arr) {
            if (!arr?.length) return;

            const path = arr.map(d => new kakao.maps.LatLng(d.rootListLatitude, d.rootListLongitude));

            if (polyline) polyline.setMap(null);

            polyline = new kakao.maps.Polyline({
                path,
                strokeWeight: 3,
                strokeColor: '#FE2E2E',
                strokeOpacity: 0.5,
                strokeStyle: 'dash',
                map,
            });

            initMaker.forEach(m => m.setMap(null));
            initMaker = [];

            arr.forEach(d => {
                const m = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(d.rootListLatitude, d.rootListLongitude),
                    content: `<div style="
          font-size:10px;color:white;background-color:#FE2E2E;
          border-radius:50%;padding:3px 5px;opacity:0.5;
        ">${d.rootListIndex}</div>`
                });
                m.setMap(map);
                initMaker.push(m);
            });
        }

        function drawAuthPolyline(arr) {
            if (!arr?.length) return;

            const path = arr.map(d => new kakao.maps.LatLng(d.rootAuthListLatitude, d.rootAuthListLongitude));
            if (selPolyline) selPolyline.setMap(null);

            selPolyline = new kakao.maps.Polyline({
                path,
                strokeWeight: 4,
                strokeColor: '#FA5858',
                strokeStyle: 'solid',
                map,
            });

            addAuthMarkers(arr);
        }

        function addAuthMarkers(arr) {
            selMaker.forEach(m => m.setMap(null));
            selMaker = [];

            arr.forEach(d => {
                const m = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(d.rootAuthListLatitude, d.rootAuthListLongitude),
                    content: `<img src="https://img.icons8.com/stickers/30/standing-man-skin-type-1.png"/>`
                });
                m.setMap(map);
                selMaker.push(m);
            });
        }

        function getCenter(arr) {
            if (!arr.length) return new kakao.maps.LatLng(37.5666805, 126.9784147);
            const avgLat = arr.reduce((s,d)=>s+d.rootAuthListLatitude,0)/arr.length;
            const avgLng = arr.reduce((s,d)=>s+d.rootAuthListLongitude,0)/arr.length;
            return new kakao.maps.LatLng(avgLat, avgLng);
        }

        document.querySelectorAll('h6[name="click-address"]').forEach(el => {
            el.addEventListener('click', () => {
                const {lat, lng} = el.dataset;
                const pos = new kakao.maps.LatLng(+lat, +lng);
                if (marker) marker.setMap(null);

                marker = new kakao.maps.Marker({ position: pos, map });
                map.setCenter(pos);
                map.setLevel(2);
            });
        });

        function modifySaveCheckList() {
            const arr = JSON.parse(sessionStorage.getItem("checkRootUser")) || [];
            document.querySelectorAll('input[name="checkbox"]').forEach(cb => {
                const ti = cb.dataset.title;
                const m = arr.find(it => it.rootAuthListTitle === ti);
                if (m) {
                    cb.checked = true;
                    const fc = cb.closest('li').querySelector('.file-container');
                    if (fc) {
                        fc.style.display = 'block';
                        if (m.rootAuthListImagePath) {
                            const img = document.createElement('img');
                            img.src = m.rootAuthListImagePath;
                            img.classList.add('image-preview');
                            img.style.cssText = 'width:80px;height:80px;object-fit:cover;margin-bottom:10px';
                            fc.insertBefore(img, fc.firstChild);
                        }
                    }
                }
            });
        }

        document.querySelectorAll('input[name="checkbox"]').forEach(cb => {
            cb.addEventListener('change', () => {
                document.getElementById("checkVaild").style.display = 'none';
                const li = cb.closest('li');
                const fc = li.querySelector('.file-container');
                const obj = {
                    rootAuthListTitle: cb.dataset.title,
                    rootAuthListLatitude: cb.dataset.latitude,
                    rootAuthListLongitude: cb.dataset.longitude,
                    rootAuthListAddress: cb.dataset.address,
                    rootAuthListRoadAddress: cb.dataset.roadaddress,
                    rootAuthListLink: cb.dataset.link,
                    rootAuthListCategory: cb.dataset.category
                };
                let arr = JSON.parse(sessionStorage.getItem("checkRootUser"))||[];
                if (cb.checked) {
                    if (!arr.some(it=>it.rootAuthListTitle===obj.rootAuthListTitle))
                        arr.push(obj);
                    fc.style.display='block';
                } else {
                    arr = arr.filter(it=>it.rootAuthListTitle!==obj.rootAuthListTitle);
                    fc.style.display='none';
                }
                sessionStorage.setItem("checkRootUser", JSON.stringify(arr));
                checkDrawPolyline();
            });
        });

        function updateSelectList() {
            const ul = document.getElementById("rootSelectList");
            ul.innerHTML = '';
            const arr = JSON.parse(sessionStorage.getItem("checkRootUser")) || [];
            if (!arr.length) {
                ul.innerHTML = '<li> 위치를 추가하세요 </li>';
                return;
            }
            arr.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.rootAuthListTitle;
                li.classList.add("root-list-style");
                ['rootAuthListTitle','rootAuthListAddress','rootAuthListRoadAddress','rootAuthListLatitude','rootAuthListLongitude','rootAuthListLink','rootAuthListCategory']
                    .forEach(k=>li.dataset[k] = item[k]);
                const btn = document.createElement('button');
                const icon = document.createElement('i');
                icon.classList.add('bi','bi-x');
                btn.appendChild(icon);
                btn.classList.add('root-remove-btn-style');
                btn.addEventListener('click', ev=>{
                    ev.stopPropagation();
                    removeSelectStorage(item);
                });
                li.appendChild(btn);
                ul.appendChild(li);
            });
        }

        document.getElementById("rootSelectList").addEventListener('click', ev => {
            const li = ev.target.closest('.root-list-style');
            if (!li) return;
            const pos = new kakao.maps.LatLng(+li.dataset.rootAuthListLatitude, +li.dataset.rootAuthListLongitude);
            map.setCenter(pos);
            map.setLevel(2);
            if (marker) marker.setMap(null);
            marker = new kakao.maps.Marker({ position: pos, map });
        });

        function checkDrawPolyline() {
            const arr = JSON.parse(sessionStorage.getItem("checkRootUser"))||[];
            if (!arr.length) return;
            if (selPolyline) selPolyline.setMap(null);
            selMaker.forEach(m=>m.setMap(null));
            selMaker = [];
            const path = arr.map(d=>new kakao.maps.LatLng(d.rootAuthListLatitude, d.rootAuthListLongitude));
            selPolyline = new kakao.maps.Polyline({
                path,
                strokeWeight: 3,
                strokeColor: '#FA5858',
                strokeStyle: 'solid',
                map
            });
            arr.forEach(d=>{
                const m = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(d.rootAuthListLatitude, d.rootAuthListLongitude),
                    content: `<img src="https://img.icons8.com/stickers/30/standing-man-skin-type-1.png"/>`
                });
                m.setMap(map);
                selMaker.push(m);
            });
            updateSelectList();
        }

        document.getElementById("map-button").addEventListener('click', () => {
            const bounds = new kakao.maps.LatLngBounds();
            rootList.forEach(d=>bounds.extend(new kakao.maps.LatLng(d.rootAuthListLatitude, d.rootAuthListLongitude)));
            map.setBounds(bounds);
        });

        document.getElementById("map-root-remove-button").addEventListener('click', () => {
            if (selPolyline) selPolyline.setMap(null);
            selMaker.forEach(m=>m.setMap(null));
            selMaker = [];
            document.querySelectorAll('input[name="checkbox"]').forEach(cb=>cb.checked=false);
            sessionStorage.removeItem("checkRootUser");
        });

        document.getElementById("map-marker-remove-button").addEventListener('click', () => {
            if (marker) marker.setMap(null);
        });

        document.getElementById("form-submit").addEventListener('click', ev => {
            const saveForm = document.getElementById("register-form");
            const selForm = document.getElementById("select-form");
            const arr = JSON.parse(sessionStorage.getItem("checkRootUser"))||[];
            document.getElementById("rootListData").value = JSON.stringify(arr);
            const checkVaild = document.getElementById("checkVaild");
            const checked = document.querySelectorAll('input[name="checkbox"]:checked').length > 0;
            checkVaild.style.display = checked ? 'none' : 'block';
            saveForm.classList.add('was-validated');
            selForm.classList.add('was-validated');
            if (!checked || !saveForm.checkValidity() || !selForm.checkValidity()) {
                ev.preventDefault();
                ev.stopPropagation();
            } else {
                sessionStorage.removeItem("checkRootUser");
                const mode = document.getElementById("form-mod").value;
                const authSeq = document.getElementById("rootAuthSeq").value;
                document.getElementById("rootSeq").value = document.getElementById("select-root").value;
                saveForm.action = (mode === 'save') ? '/root/form/save' : `/root/form/modify/${authSeq}`;
                saveForm.submit();
            }
        });

        document.querySelectorAll('.file-input').forEach(inp => {
            inp.addEventListener('change', ev => {
                const file = ev.target.files[0];
                if (file?.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        let img = inp.parentElement.querySelector('.image-preview');
                        if (!img) {
                            img = document.createElement('img');
                            img.classList.add('image-preview');
                            img.style.cssText = 'width:80px;height:80px;object-fit:cover;margin-bottom:10px';
                            inp.parentElement.insertBefore(img, inp);
                        }
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function removeSelectStorage(item) {
            let arr = JSON.parse(sessionStorage.getItem("checkRootUser")) || [];
            arr = arr.filter(it => it.rootAuthListTitle !== item.rootAuthListTitle);
            sessionStorage.setItem("checkRootUser", JSON.stringify(arr));
            document.querySelectorAll('input[name="checkbox"]').forEach(cb => {
                if (cb.dataset.title === item.rootAuthListTitle) {
                    cb.checked = false;
                    const fc = cb.closest('li').querySelector('.file-container');
                    fc.style.display = 'none';
                    fc.querySelector('input').value = '';
                }
            });
            selMaker = selMaker.filter(m => {
                const pos = m.getPosition();
                if (pos.getLat() === +item.rootAuthListLatitude && pos.getLng() === +item.rootAuthListLongitude) {
                    m.setMap(null);
                    return false;
                }
                return true;
            });
            checkDrawPolyline();
            updateSelectList();
        }

        document.getElementById("select-root").addEventListener("change", function () {
            sessionStorage.removeItem("checkRootUser");
            // document.getElementById("select-form").submit();
            const selectedValue = this.value;
            window.location.href = '/root/form?rootSeq=' + selectedValue;
        });

    </script>
</main>

</html>
<link rel="stylesheet" type="text/css" th:href="@{/css/mj-design-css.css}">