<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <div class="d-flex justify-content-center align-items-center page-total-main-bg mb-5 shadow-sm">
        <h2 class="text-center text-white py-2 font-bold-style">한식루트 인증</h2>
    </div>
    <div class="container py-5">
        <!--content-->
        <section>
            <!--*** content 넣어야할 부분 (넣고 아래 div height 700px 준거 없애줘야 할거임) ***-->
            <div>
                <!-- **내용** -->
                <div class="d-flex justify-content-between fs-6">
                    <div>
                        <h3 th:text="${rootAuth.rootAuthTitle}"></h3>
                    </div>
                    <div class="d-flex align-items-center me-2" style="color: #333;">
                        <i class="bi bi-person-fill me-2 mt-1"></i>
                        <span th:text="${rootAuth.userId.username}" class="me-4"></span>
                        <i class="bi bi-clock-fill me-2 mt-1" style="font-size: 12px"></i>
                        <span
                                th:text="${#temporals.format(rootAuth.rootAuthDate, 'yyyy-MM-dd HH:mm')}"
                                th:attr="data-bs-title= ${rootAuth.rootAuthModifyDate != null } ? '수정일: ' + ${#temporals.format(rootAuth.rootAuthModifyDate, 'yyyy-MM-dd HH:mm')} : '등록일'"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                style="cursor: pointer;">
                    </span>
                    </div>
                </div>
                <input type="hidden" id="select-value" th:value="${rootAuth.rootAuthSeq}">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between" style=" height: 580px;">
                            <!--left-->
                            <div class="d-flex flex-column justify-content-between" style="width: 60%;">
                                <!--top-->
                                <div id="map" style="width: 100%; flex-grow: 1;"></div>
                            </div>
                            <!--right-->
                            <div class="h-100 overflow-y-auto" style="width: 35%;">
                                <ul th:if="${rootAuthList}" class="p-3 mb-0 root-li">
                                    <li id="search-data-list" th:each="rootAuthList : ${rootAuthList}" class="">
                                        <div class="d-flex flex-row p-2">
                                            <div class="my-2" style="width: 90%;">
                                                <h6 th:utext="${rootAuthList.rootAuthListIndex} + '. ' + ${rootAuthList.rootAuthListTitle}"
                                                    style="font-weight: bold; cursor: pointer;"
                                                    name="click-address"
                                                    th:data-lat="${rootAuthList.rootAuthListLatitude}"
                                                    th:data-lng="${rootAuthList.rootAuthListLongitude}"></h6>
                                                <p th:text="'카테고리: ' + ${rootAuthList.rootAuthListCategory}"
                                                   class="mb-2" style="font-size: 14px; color: #777"></p>
                                                <p th:text="'지번: ' + ${rootAuthList.rootAuthListAddress}" class="mb-2"
                                                   style="font-size: 14px; color: #444"></p>
                                                <p th:text="'도로명: ' + ${rootAuthList.rootAuthListRodeAddress}"
                                                   class="mb-0" style="font-size: 14px; color: #444"></p>
                                                <input type="hidden" id="latitude"
                                                       th:value="${rootAuthList.rootAuthListLatitude}"/>
                                                <input type="hidden" id="longitude"
                                                       th:value="${rootAuthList.rootAuthListLongitude}"/>
                                                <img th:if="${rootAuthList.rootAuthListImagePath != null}"
                                                     th:src="${rootAuthList.rootAuthListImagePath}" width="50px"
                                                     height="50px" class="mt-2" style="cursor: pointer"
                                                     th:data-img="${rootAuthList.rootAuthListImagePath}"
                                                     onclick="openModal(this)">
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h5>후기</h5>
                            <div class="card">
                                <div class="card-body">
                                    <p th:utext="${rootAuth.rootAuthContent}"></p>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <a th:href="@{|/root/form/modify/${rootAuth.rootAuthSeq}|}"
                               sec:authorize="isAuthenticated()"
                               th:if="${#authentication.name == rootAuth.userId.username}"
                               type="button" class="btn btn-sm btn-outline-secondary me-2">수정</a>
                            <a href="javascript:void(0);" sec:authorize="isAuthenticated()"
                               class="btn btn-sm btn-outline-secondary" id="delete-btn"
                               th:if="${#authentication.name == rootAuth.userId.username}"
                               th:data-url="@{|/root/form/delete/${rootAuth.rootAuthSeq}|}">
                                삭제
                            </a>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <input type="button" id="map-button" class="btn btn-outline-secondary me-2" value="루트 확인">
                    <a th:href="@{/root/list}" class="btn btn-outline-secondary root-a-outline-se">목록</a>
                </div>
                <!-- 모달 창 -->
                <div id="root-image-modal" class="root-modal">
                    <span class="close">&times;</span>
                    <div id="root-image-container" class="h-100 d-flex justify-content-center align-items-center">
                        <img class="modal-content" id="root-modal-image">
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script th:inline="javascript" layout:fragment="script">
        let map;
        let marker;
        let polyline;
        let rootList = /*[[${rootList}]]*/ [];
        let rootAuthList = /*[[${rootAuthList}]]*/ [];
        let selPolyline;

        let initMaker = [];
        let selMaker = [];

        document.addEventListener("DOMContentLoaded", () => {
            setMap();
            drawPolyline(rootList);
            drawAuthPolyline(rootAuthList);
        });

        function setMap() {
            let center;

            if (!rootList || rootList.length === 0) {
                center = new kakao.maps.LatLng(37.5666805, 126.9784147);
            } else {
                center = getCenter(rootList);
            }

            const container = document.getElementById('map');
            const options = {
                center: center,
                level: 5
            };

            map = new kakao.maps.Map(container, options);
        }

        function drawPolyline(value) {
            if (!value || value.length === 0) return;

            const path = value.map(data => new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude));

            if (polyline) {
                polyline.setMap(null);
            }

            polyline = new kakao.maps.Polyline({
                map: map,
                path: path,
                strokeWeight: 2,
                strokeColor: '#ff6767',
                strokeOpacity: 0.4,
                strokeStyle: 'dash'
            });

            initMaker.forEach(m => m.setMap(null));
            initMaker = [];

            value.forEach((data) => {
                const position = new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude);

                const content = `
        <div style="
            font-size: 11px;
            color: white;
            width: 22px;
            height: 22px;
            padding: 3px;
            background-color: #ff6767;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-weight: bold;
            opacity: 0.5;
        ">
            ${data.rootListIndex}
        </div>
    `;

                const customOverlay = new kakao.maps.CustomOverlay({
                    position: position,
                    content: content,
                    yAnchor: 1
                });

                customOverlay.setMap(map);
                initMaker.push(customOverlay);
            });
        }

        function drawAuthPolyline(value) {
            if (!value || value.length === 0) return;

            const path = value.map(data => new kakao.maps.LatLng(data.rootAuthListLatitude, data.rootAuthListLongitude));

            if (selPolyline) {
                selPolyline.setMap(null);
            }

            selPolyline = new kakao.maps.Polyline({
                map: map,
                path: path,
                strokeWeight: 3,
                strokeColor: '#FA5858',
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });

            addAuthMarkers(value);
        }

        function addAuthMarkers(value) {
            selMaker.forEach(m => m.setMap(null));
            selMaker = [];

            value.forEach(data => {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(data.rootAuthListLatitude, data.rootAuthListLongitude),
                    map: map,
                    image: new kakao.maps.MarkerImage(
                        "https://img.icons8.com/stickers/30/standing-man-skin-type-1.png",
                        new kakao.maps.Size(30, 30),
                        { offset: new kakao.maps.Point(15, 30) }
                    )
                });
                selMaker.push(marker);
            });
        }

        function getCenter(value) {
            if (value.length === 0) return new kakao.maps.LatLng(37.5666805, 126.9784147);

            let latSum = 0;
            let lngSum = 0;

            value.forEach(data => {
                latSum += data.rootListLatitude;
                lngSum += data.rootListLongitude;
            });

            return new kakao.maps.LatLng(latSum / value.length, lngSum / value.length);
        }

        document.querySelectorAll('h6[name="click-address"]').forEach((data) => {
            data.addEventListener("click", function () {
                const lat = parseFloat(data.dataset.lat);
                const lng = parseFloat(data.dataset.lng);

                const position = new kakao.maps.LatLng(lat, lng);

                if (marker) marker.setMap(null);

                marker = new kakao.maps.Marker({
                    position: position,
                    map: map
                });

                map.setCenter(position);
                map.setLevel(3);
            });
        });

        document.getElementById("map-button").addEventListener("click", function () {
            const bounds = new kakao.maps.LatLngBounds();

            rootList.forEach(data => {
                const coord = new kakao.maps.LatLng(data.rootListLatitude, data.rootListLongitude);
                bounds.extend(coord);
            });

            map.setBounds(bounds);
        });

        document.getElementById("delete-btn").addEventListener("click", function () {
            if (confirm("삭제하시겠습니까?")) {
                window.location.href = this.dataset.url;
            } else {
                console.log("취소");
            }
        })


    </script>

</main>

</html>
<link rel="stylesheet" type="text/css" th:href="@{/css/mj-design-css.css}">